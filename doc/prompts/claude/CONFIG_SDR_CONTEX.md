# ТЗ: Быстрые SDR‑настройки (PARAMS) и отдельная страница «SDR Config»

Версия: 1.0\
Проект: **COSPAS/SARSAT Beacon Tester — DSP Client v2.x**

---

## 1. Цель

1. Обновить левый блок **PARAMS** для оперативного управления ключевыми параметрами приема.
2. Ввести отдельную конфигурационную страницу/модальное окно **SDR Config** для полной настройки радиотракта и сохранения пресетов.

## 2. Область работ

- Фронтенд (UI/UX, вёрстка, валидация, локальное сохранение пресетов).
- Бэкенд API (расширение `/api/control/params`, новые `/api/sdr/get_config`, `/api/sdr/set_config`).
- Сервис DSP (обновление применяемых параметров без перезапуска, ретюн устройства при изменении частоты/дискретизации).

## 3. Быстрые настройки в **PARAMS**

Заменить текущий состав полей и кнопок.

### 3.1 Поля

1. **Target signal (Hz)** — `target_signal_hz`

   - Описание: «Частота сообщения (целевой канал)».
   - Ед.: Гц (ввод с автопереводом из МГц при наличии `MHz`/`mhz`/`,`/`.`).
   - Диапазон: `100 kHz … 6 GHz` (зависит от SDR, валидировать по capability).
   - Действие при Apply: сохранить и отразить в статусе; использовать как опорный параметр для демодуляции/метрик.

2. **Threshold (dBm)** — `thresh_dbm`

   - Диапазон: `[-120 … 0]` шаг `0.5 dB`.
   - Действие при Apply: немедленно обновлять порог в DSP.

> **Удалить поле**: *RMS Win (ms)*. Поле и вся логика UI/запросов, связанные с ним, должны быть убраны.

### 3.2 Кнопки

- **Apply** — отправляет единый JSON в `/api/control/params`.
- **SDR…** — открывает модал/страницу **SDR Config** (см. раздел 4).

### 3.3 Пример полезной нагрузки (PARAMS → set\_params)

```json
{
  "cmd": "set_params",
  "target_signal_hz": 406037000,
  "thresh_dbm": -45
}
```

### 3.4 Отображение в нижней строке статуса

- Отобразить `Target:` в Гц/МГц рядом с уже существующими фазовыми метриками.
- В панели «Signal Parameters» добавить строку **Target freq, kHz** (автоизмерение/копия target).

## 4. Страница/модал **SDR Config**

Открывается по кнопке **SDR…**; две вкладки: *Radio* и *Recording*.

### 4.1 Поля (Radio)

- **Center frequency (Hz)** — `center_freq_hz` (ретюн устройства при Apply).
- **Sample rate (S/s)** — `sample_rate_sps` (пересоздание стрима).
- **Baseband shift (Hz)** — `bb_shift_hz` и `bb_shift_enable` (NCO/цифровой сдвиг).
- **Frequency correction (HZ)** —   на абсолютное `freq_corr_hz``, 
- **AGC** — `agc` (bool).
- **Manual gain (dB)** — `gain_db` (активно если AGC=false).
- **Bias‑T** — `bias_t` (bool, если поддерживается).
- **Antenna/Port** — `antenna` (select, если поддерживается).
- **Device/Driver** — readonly (из `/api/state`).

### 4.2 Поля (Recording)

- **SigMF save** — переключатель «вкл/выкл».
- **Path / Filename pattern**.
- **Datatype** (cf32/ci16 и т.п., если доступно).
- **Chunk / Rotate** параметры.

### 4.3 Управление

- **Apply** — POST `/api/sdr/set_config` (см. API), применяет изменения; при необходимости выполняется ретюн/реинициализация.
- **Load / Save preset** — локальные пресеты в `localStorage` + (опционально) серверные (JSON).
- **Defaults** — сброс к значениям по умолчанию.

## 5. API

### 5.1 Изменения существующего

**POST** `/api/control/params`\
Тело: плоский JSON с любыми из полей ниже (частичное обновление допускается):

```json
{
  "target_signal_hz": <int>,
  "thresh_dbm": <float>
}
```

Ответ: `{ "ok": true, "applied": { … } }`.

### 5.2 Новые эндпоинты

1. **GET** `/api/sdr/get_config`\
   Ответ пример:

```json
{
  "center_freq_hz": 406000000,
  "sample_rate_sps": 1000000,
  "bb_shift_enable": true,
  "bb_shift_hz": -37000,
  "freq_corr_hz": 0,
  "agc": false,
  "gain_db": 30.0,
  "bias_t": false,
  "antenna": "RX",
  "device": "rtlsdr (serial 00000001)"
}
```

2. **POST** `/api/sdr/set_config`\
   Тело: любой поднабор полей из `get_config`.\
   Логика применения:

- При изменении `center_freq_hz` или `sample_rate_sps` — *retune/restart stream*.
- При изменении `bb_shift_*` — пересчёт NCO.
- При изменении `gain_db`/`agc`/`freq_corr_hz`/`bias_t`/`antenna` — применить к драйверу, если поддерживается; иначе сохранить и применить на следующем старте.\
  Ответ: `{ "ok": true, "applied": { … }, "retuned": true|false }`.

## 6. Валидация и UX

- Все числовые поля принимают суффиксы: `k`, `M`, `G`, `ppm`, а также запятую/точку как десятичный разделитель.
- Для частот — шаг ввода колёсиком/стрелками: 1 kHz; для gain: 0.5 dB; для PPM: 0.1.
- Валидация диапазонов в UI + в бэкенде.
- Toast/alert при ретюне («Retuned to 406.000 MHz @ 1.000 MS/s»).

## 7. Сервис DSP — применение

- Новые поля добавить в структуру runtime‑параметров.
- Обработчик `set_params` принимает `target_signal_hz`, `thresh_dbm`.
- Публикация в `/api/state` расширяется: включить `target_signal_hz`, актуальные SDR‑параметры.
- Ретюн и пересоздание потоков — без потери устойчивости (graceful stop/start I/O).
- Логгер: события `SDR_RETUNE`, `SDR_PARAM_APPLY`, `PARAMS_APPLY`.

## 8. Хранение и пресеты

- UI: `localStorage` ключ `dsp2web.sdr.presets` (массив именованных конфигов).
- (Опционально) Серверные пресеты в `~/.tester_sdr/presets.json`.

## 9. Тест‑план (минимум)

1. Изменение `thresh_dbm` меняет детекцию без перезапуска.
2. Ввод/применение `target_signal_hz` отражается в статусе и используется в расчетах.
3. Retune при изменении `center_freq_hz`/`sample_rate_sps` не роняет поток.
4. `bb_shift_enable/hz` меняют спектр в реальном времени.
5. AGC/Manual gain корректно переключаются.
6. Поле *RMS Win* отсутствует в UI и запросах.
7. Preset → Load/Save/Defaults рабочие после перезапуска браузера.
8. Все поля принимают суффиксы (`406.037M`, `-37k`, `+0.5ppm`).

## 10. i18n/Текст

- Добавить ключи для новых лейблов/подсказок.
- Англ/Рус локали.

## 11. Согласование API/Названий

- Утвердить единый стандарт:  **Hz**, поле будет называться `freq_corr_hz` .

## 12. Не входит в объём

- Поддержка специфичных регистров отдельных SDR вне общих абстракций.
- Запись IQ «по кнопке» с продвинутым триггером — отдельное ТЗ.

---

### Готово к реализации

- Сначала фронт (UI/валидация/эндпоинты), затем бэкенд‑скелет эндпоинтов и применение параметров в сервисе, далее интеграционные тесты.

