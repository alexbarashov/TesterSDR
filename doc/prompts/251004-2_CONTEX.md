# Реализация Zero-IF контракта: перенос BB-shift из приложений в backends

**Дата:** 2025-10-04
**Задача:** Реализовать Zero-IF контракт согласно `doc/SDR_backends_zero_if_contract.md`

## Проблема

После удаления NCO из приложений (beacon406_PSK_FM-plot.py, beacon_dsp_service.py) обнаружено:
- При работе с RTL-SDR сигнал смещён на **+37 кГц** вместо Zero-IF (0 Hz)
- Графики Phase и FM показывают ошибку из-за неправильной частоты несущей
- BB-shift (baseband shift) не применяется внутри backends

## Корневая причина

1. **NCO удалён из приложений**, но BB-shift не был добавлен в backends
2. **if_offset_hz не передавался** в SoapyBackend через make_backend()
3. **Неправильный расчёт _mix_w**: использовалась HW частота дискретизации вместо частоты после децимации
4. **Двойная обрезка графиков** в beacon_dsp2plot.py (DSP уже обрезал + дополнительная обрезка по core_gate)

## Решение

### 1. Добавлен BB-shift в SoapyBackend (beacon406/lib/backends.py)

**__init__() метод (строки 192-205):**
```python
# Инициализация NCO для BB-shift (Zero-IF контракт)
# Используем ту же логику, что старый NCO в beacon406_PSK_FM-plot.py:
# BB_SHIFT_HZ = IF_OFFSET_HZ, mixer = exp(+1j × 2π × BB_SHIFT_HZ / Fs × n)
# ВАЖНО: _mix_w вычисляется для actual_sample_rate_sps (ПОСЛЕ децимации)
self._mix_phase = 0.0
self._mix_shift_hz = self._if_offset_hz  # БЕЗ инверсии знака!
self._mix_w = 2.0 * np.pi * self._mix_shift_hz / self.actual_sample_rate_sps
```

**read() метод (строки 348-355):**
```python
# === BB-shift для Zero-IF (применяется ПОСЛЕ децимации) ===
if self._mix_w != 0 and len(x) > 0:
    n = np.arange(len(x), dtype=np.float64)
    ph = self._mix_phase + self._mix_w * n
    mixer = np.exp(1j * ph).astype(np.complex64)
    x = x * mixer
    self._mix_phase = float((self._mix_phase + self._mix_w * len(x)) % (2.0 * np.pi))
```

**Логирование (строки 201-203):**
```python
if self._if_offset_hz != 0:
    log.info("%s: if_offset_hz=%.0f Hz → BB-shift=%.0f Hz (Zero-IF контракт)",
             drv_key, self._if_offset_hz, self._mix_shift_hz)
```

### 2. Исправлена передача if_offset_hz в make_backend() (строка 724)

**До:**
```python
return SoapyBackend(
    device_args=device_args or drv,
    sample_rate=sample_rate,
    center_freq=center_freq,
    gain_db=gain_db,
    agc=agc,
    corr_ppm=corr_ppm,
)
```

**После:**
```python
return SoapyBackend(
    device_args=device_args or drv,
    sample_rate=sample_rate,
    center_freq=center_freq,
    gain_db=gain_db,
    agc=agc,
    corr_ppm=corr_ppm,
    **extras  # Передаём if_offset_hz и другие параметры
)
```

### 3. Удалён NCO из приложений

**beacon406_PSK_FM-plot.py:**
- Удалены переменные: `BB_SHIFT_ENABLE`, `BB_SHIFT_HZ`
- Удалены поля класса: `self.nco_phase`, `self.nco_k`
- Удалён код применения NCO миксера (строки 1223-1224)
- Добавлены комментарии: "NCO удалён - BB-shift применяется внутри backends"

**beacon406-plot.py:**
- Аналогичные изменения
- Добавлен параметр `if_offset_hz=IF_OFFSET_HZ` во все вызовы safe_make_backend

**beacon_dsp_service.py:**
- NCO уже был удалён ранее
- Код уже передавал `if_offset_hz` для non-file бэкендов

### 4. Исправлена двойная обрезка графиков в beacon_dsp2plot.py

**Проблема:** Графики Phase и FM обрезались дважды:
1. DSP сервис обрезает с START_DELAY_MS=1ms и PHASE_TRIM_END_MS=1ms
2. beacon_dsp2plot.py дополнительно обрезал по core_gate

**Решение (строки 618-638):**
```python
# Фаза график - НЕ обрезаем, DSP уже обрезал с START_DELAY_MS и PHASE_TRIM_END_MS
if px.size > 1 and py.size == px.size:
    self._phase_x = px
    self._phase_y = py
    self.ln_phase.set_data(px, py)

# FM график - НЕ обрезаем, DSP уже обрезал с START_DELAY_MS
if fx.size > 1 and fy.size == fx.size:
    self._fm_x = fx
    self._fm_y = fy
    self.ln_fm.set_data(fx, fy)
```

## Ключевые моменты реализации

### Математика BB-shift

Для `IF_OFFSET_HZ = -37000`:
- SDR центр: 406.000 МГц
- Сигнал реально: 406.037 МГц
- В baseband: **+37 кГц** (правее центра)

Компенсация:
- `_mix_shift_hz = if_offset_hz = -37000` (БЕЗ инверсии знака!)
- `_mix_w = 2π × (-37000) / Fs` (отрицательная частота)
- `mixer = exp(+1j × _mix_w × n) = exp(-1j × 37000 × ...)`
- Результат: смещение **-37 кГц** → Zero-IF (0 Hz) ✓

### Почему actual_sample_rate_sps, а не sample_rate_hw?

BB-shift применяется ПОСЛЕ децимации, поэтому:
- RTL-SDR: HW Fs = 1.024 МГц → decimation=1 → actual Fs = 1.024 МГц
- HackRF: HW Fs = 2.4 МГц → decimation=2 → actual Fs = 1.2 МГц

Если использовать `sample_rate_hw` для расчёта `_mix_w`, получим неправильную частоту сдвига!

### Почему НЕ инвертируем знак if_offset_hz?

Старый NCO в beacon406_PSK_FM-plot.py использовал:
```python
BB_SHIFT_HZ = IF_OFFSET_HZ  # -37000
nco_k = 2π × BB_SHIFT_HZ / Fs  # отрицательная
mixer = exp(+1j × nco_k × n)  # даёт -37 кГц смещение
```

Мы копируем эту логику ТОЧНО, поэтому:
```python
_mix_shift_hz = if_offset_hz  # -37000 (БЕЗ инверсии!)
_mix_w = 2π × _mix_shift_hz / Fs  # отрицательная
mixer = exp(+1j × _mix_w × n)  # даёт -37 кГц смещение
```

## Результаты тестирования

### RTL-SDR с beacon406_PSK_FM-plot.py
```
rtlsdr: if_offset_hz=-37000 Hz → BB-shift=-37000 Hz (Zero-IF контракт)
```
- ✅ Сигнал на 0 Hz (Zero-IF)
- ✅ Phase график корректный
- ✅ FM график корректный
- ✅ Декодирование PSK сообщений работает

### RTL-SDR с beacon_dsp_service.py + beacon_dsp2plot.py
```
rtlsdr: if_offset_hz=-37000 Hz → BB-shift=-37000 Hz (Zero-IF контракт)
```
- ✅ Сигнал на 0 Hz (Zero-IF)
- ✅ Phase график полный (~518ms вместо ~350ms после исправления двойной обрезки)
- ✅ FM график полный
- ✅ RMS график корректный

### beacon406-plot.py с RTL-SDR
- ✅ Работает корректно (аналогично beacon406_PSK_FM-plot.py)

## Изменённые файлы

1. **beacon406/lib/backends.py**
   - Добавлен BB-shift в SoapyBackend.__init__() и read()
   - Исправлен make_backend() для передачи `**extras`
   - Добавлено логирование BB-shift

2. **beacon406/beacon406_PSK_FM-plot.py**
   - Удалён NCO (BB_SHIFT_*, nco_phase, nco_k)
   - Удалено применение NCO миксера
   - Передача if_offset_hz через все safe_make_backend()

3. **beacon406/beacon406-plot.py**
   - Удалён NCO (аналогично PSK_FM-plot)
   - Передача if_offset_hz

4. **beacon406/beacon_dsp2plot.py**
   - Убрана двойная обрезка графиков Phase и FM по core_gate
   - Теперь доверяет данным от DSP (уже обрезаны с START_DELAY_MS/PHASE_TRIM_END_MS)

## Соответствие контракту Zero-IF

Согласно `doc/SDR_backends_zero_if_contract.md`:

✅ **Правило 1:** Выход backends всегда в Zero-IF (несущая = 0 Hz)
✅ **Правило 2:** IF-смещения компенсируются внутри backends
✅ **Правило 3:** Внешние модули НЕ учитывают IF
✅ **Правило 4:** Для file backend: if_offset_hz=0, BB-shift выключен
✅ **Правило 5:** Для Soapy backends: BB-shift = -effective_if_hw_hz (через NCO)

## Известные ограничения

1. **FilePlaybackBackend** имеет старую логику BB-shift (строки 441-445), которая НЕ изменена
2. **RSA306Backend** не протестирован (нет устройства)
3. **Decimation > 1** протестирована только логически (RTL-SDR использует decim=1)

## Следующие шаги (опционально)

1. Протестировать с HackRF (decim=2, HW Fs=2.4МГц)
2. Протестировать с Airspy (decim=10, HW Fs=10МГц)
3. Унифицировать FilePlaybackBackend для использования той же логики BB-shift
4. Добавить юнит-тесты для проверки Zero-IF (как в контракте, строка 45)
