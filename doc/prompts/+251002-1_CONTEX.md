# ТЗ: обновить `_dsp2plot`

## Цель

1. Во **втором окне** `beacon_dsp2plot.py` сделать интерфейс и поведение аналогичными второму окну из `beacon406_PSK_FM-plot.py` (кнопки, индикаторы/таблицы, реакции на нажатия, логика паузы обновлений, спектр и пр.).
2. В **первое окно** `_dsp2plot` добавить **пунктирную горизонтальную линию порога** (уровень в dBm) поверх графика Sliding RMS.

---

## База для изменений

* Файл-назначение: `beacon_dsp2plot.py` (класс `Dsp2PlotUI`). Во втором окне сейчас три оси: RMS/Фаза/FM и минимум кнопок (Save SigMF/Exit). 
* Источник поведения и UI: `beacon406_PSK_FM-plot.py` (класс/логика «Pulse window — RMS + Δf + сервисные кнопки», включая кнопки **Спектр**, **Статус SDR**, **Параметры**, **Сообщение**, **Стоп/Старт** и все связанные обработчики/табличные окна). 

---

## 1) Второе окно `_dsp2plot`: выровнять под `_PSK_FM-plot`

### 1.1. Кнопки и компоновка (нижняя панель)

Добавить во второе окно `_dsp2plot` те же элементы управления, что и в `_PSK_FM-plot`:

* **Сообщение** (`btn_msg`) → окно с таблицей полей 406-сообщения (HEX → биты → расшифровка).
* **Параметры** (`btn_params`) → окно со снепшотом фазовых метрик (Pos/Neg/Rise/Fall/Asymmetry/Fmod/мощность/длительности).
* **Статус SDR** (`btn_stat`) → окно-таблица статуса backend’а (ключевые поля и prettified текст).
* **Спектр** (`btn_spec`) → статический спектр «ядра импульса» с маской C/S T.001 в dBc (центр 0 Гц, окно, усреднение, гейтинг).
* **Save IQ** (`btn_save`) → сохранение текущего сегмента IQ в CF32 (бит-в-бит).
* **Стоп/Старт** (`btn_stop`) → **тумблер** блокировки/разблокировки обновления второго окна без остановки SDR (с сохранением последнего кадра).

Все подписи, расположение и размеры кнопок — как в `_PSK_FM-plot`, адаптировать только координаты add_axes под текущее `fig2` `_dsp2plot`. Поведение кнопок и тексты («Стоп/Старт», «Параметры», «Сообщение», «Спектр», «Статус SDR», «Save IQ») — **идентичные** источнику. 

### 1.2. Логика данных/состояния для кнопок

Перенести/адаптировать внутренние поля/флаги из `_PSK_FM-plot`:

* `pulse_updates_enabled` — флаг разрешения обновлений второго окна.
* Хранение последних данных импульса, необходимых для таблиц и спектра:

  * `last_phase_metrics` (снимок параметров)
  * `last_msg_hex` (HEX сообщения для декодера)
  * `last_iq_seg` (последний IQ-сегмент)
  * `last_core_gate` (гейтинг ядра импульса для спектра)
* Обработчики:

  * `_on_toggle_pulse_updates` — переключение Стоп/Старт (меняет текст на кнопке и флаг).
  * `_on_show_params`, `_on_show_message` — построение таблиц в отдельных окнах (Matplotlib table).
  * `_on_show_sdr_status` — таблица статуса бэкенда (+ prettified, если доступно).
  * `_on_show_spectrum` + `_plot_fft_sector` — спектр ядра импульса, окно/усреднение/нормировка dBc, маска C/S T.001.
    Все эти обработчики и структура данных должны работать в `_dsp2plot` **так же**, как в источнике. 

### 1.3. Подключение к существующим потокам данных `_dsp2plot`

* В `_dsp2plot` данные для второго окна приходят через подписку `subscribe_events`/`_on_pulse_event` (тип `"pulse"`): там уже обновляются кривые RMS/Фаза/FM.
* Дополнить `_on_pulse_event` **сохранением** необходимых полей (`last_iq_seg`, `last_core_gate`, `last_phase_metrics`, `last_msg_hex`), чтобы кнопки «Параметры/Сообщение/Спектр/Статус» имели материал для отображения.
* Если `pulse_updates_enabled = False`, входящие данные **не перерисовывают** оси второго окна (кривые остаются «заморожеными»), но **сохраняются** как «последний кадр» для сервисных окон.

Примечание: источником метрик/HEX/гейта в `_PSK_FM-plot` служат внутренние функции обработки импульса. В `_dsp2plot` эти значения приходят от сервиса в объекте события (`obj`) — либо добавьте совместимые поля в событие на стороне сервиса, либо (временный вариант) повесьте заглушки и отображайте уведомления «нет данных», как это реализовано в `_PSK_FM-plot` при их отсутствии.  

### 1.4. Визуальные настройки

* Общие пределы осей и подписи сохранить как в `_PSK_FM-plot` (ось фаз ±1.5 rad, сетки, sharex для фазы/FM).
* Заголовок `fig2` сделать по образцу: «Импульс: RMS + Фаза (±1.5 rad) + FM(Hz)». 

---

## 2) Первое окно `_dsp2plot`: пунктирная линия «уровень порога»

* Взять текущий порог из статуса: поле `thresh_dbm` (get_status → `self.last_status`). Это значение уже показывается в status-bar первой фигуры. 
* Добавить на график Sliding RMS (`self.ax_lvl`) **горизонтальную пунктирную линию** на уровне `thresh_dbm`.

  * Реализация: создать/кэшировать `Line2D` со стилем `linestyle='--'`, `alpha≈0.7`.
  * Линия должна **обновляться** при каждом `_poll_status()` (если `thresh_dbm` изменился) и всегда растягиваться на текущий X-диапазон (`self.ax_lvl.get_xlim()` после установки данных).
  * Если `thresh_dbm` отсутствует, линию скрывать.
* Легенда не обязательна; достаточно визуально читаемой пунктирной линии.

---

## 3) Горячие клавиши/UX (если уже есть — сохранить)

* Сохранить текущие hotkeys закрытия окон и поведения таймера опроса (single poll loop).
* Не изменять логику **Start/Stop acquire** первого окна; тумблер «Стоп/Старт» относится **только** к обновлениям второго окна (как в `_PSK_FM-plot`). 

---

## 4) Обратная совместимость и ограничения

* Не трогать существующие кнопки первого окна (выбор backend, Start/Stop, Выход) и строку статуса.
* В режиме `backend=file` сохранять поведение `_dsp2plot` (BB-shift выключен, быстрая отрисовка). 
* Если сервис пока не отправляет `last_iq_seg`/`core_gate`/`phase_metrics`/`hex`, кнопки «Спектр/Параметры/Сообщение» должны открывать окна с понятным сообщением «нет данных» (поведение как в источнике). 

---

## 5) Критерии приёмки

1. Во втором окне присутствуют и работают 6 кнопок: **Сообщение**, **Параметры**, **Статус SDR**, **Спектр**, **Save IQ**, **Стоп/Старт**; тексты и реакции совпадают с `_PSK_FM-plot`.
2. При «Стоп» кривые второго окна не обновляются, но сервис продолжает работать; повторное «Старт» возобновляет обновления без ошибок.
3. Кнопка **Статус SDR** показывает таблицу статуса (минимум: backend/driver/actual_sample_rate/center_freq/file_path и т.п.).
4. **Параметры** и **Сообщение** отображают таблицы, если данные есть; если нет — выводят информативное сообщение.
5. **Спектр** строит спектр ядра импульса с нормировкой dBc и маской C/S T.001; если данных нет — понятное предупреждение.
6. В первом окне поверх RMS-графика видна пунктирная линия порога; линия перемещается при изменении `thresh_dbm` и всегда совпадает с текущими пределами X.
7. Никаких регрессий в логике Start/Stop acquire, выборе backend и опросе статуса.

---

## 6) Подсказки по встройке (якоря кода)

* `_dsp2plot`: класс `Dsp2PlotUI` → блок инициализации `fig2` и нижних кнопок — сюда добавить новые кнопки и обработчики по аналогии с `_PSK_FM-plot`. Также расширить `_on_pulse_event` для сохранения «последнего» IQ/метрик/HEX/гейта. 
* `_PSK_FM-plot`: перенести обработчики `_on_show_message`, `_on_show_params`, `_on_show_sdr_status`, `_on_show_spectrum`, `_on_toggle_pulse_updates`, а также вспомогательную `_plot_fft_sector` и связанные поля состояния. Минимально адаптировать к именам полей `_dsp2plot`. 
* Порог в первом окне: обновлять/рисовать линию внутри `_update_rms_plot()` и/или сразу после него в `_poll_status()` (чтобы линия всегда растягивалась по X). 
