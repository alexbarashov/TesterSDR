# –ö–æ–Ω—Ç–µ–∫—Å—Ç —Ä–∞–±–æ—Ç—ã –æ—Ç 2025-10-04: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞–∫–ª–æ–Ω–∞ —Ñ–∞–∑—ã –≤ beacon_dsp_service.py

## –ü—Ä–æ–±–ª–µ–º–∞
beacon_dsp2plot.py + beacon_dsp_service.py –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –≥—Ä–∞—Ñ–∏–∫ —Ñ–∞–∑—ã —Å –±–æ–ª—å—à–∏–º –Ω–∞–∫–ª–æ–Ω–æ–º,
–∞ beacon406_PSK_FM-plot.py –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç (–¥–∏–∞–ø–∞–∑–æ–Ω —Ñ–∞–∑—ã ¬±1.1 —Ä–∞–¥).

## –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞ (–ù–ê–ô–î–ï–ù–ê)
FilePlaybackBackend (lib/backends.py:469) –ø—Ä–∏–º–µ–Ω—è–µ—Ç —á–∞—Å—Ç–æ—Ç–Ω–æ–µ —Å–º–µ—â–µ–Ω–∏–µ (`if_offset_hz`)
–≤–Ω—É—Ç—Ä–∏ —Å–≤–æ–µ–≥–æ –º–µ—Ç–æ–¥–∞ `read()`:
```python
out *= np.exp(-1j * ph).astype(np.complex64)
```

–ü–µ—Ä–µ–¥–∞—á–∞ `if_offset_hz=IF_OFFSET_HZ` –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä file backend –ø—Ä–∏–≤–æ–¥–∏–ª–∞ –∫ **–¥–≤–æ–π–Ω–æ–º—É**
–ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é —á–∞—Å—Ç–æ—Ç–Ω–æ–≥–æ —Å–º–µ—â–µ–Ω–∏—è, —Å–æ–∑–¥–∞–≤–∞—è –æ–≥—Ä–æ–º–Ω—ã–π –Ω–∞–∫–ª–æ–Ω —Ñ–∞–∑—ã (–¥–∏–∞–ø–∞–∑–æ–Ω ¬±1548 —Ä–∞–¥ –≤–º–µ—Å—Ç–æ ¬±1.1 —Ä–∞–¥).

## ‚úÖ –ß—Ç–æ –°–î–ï–õ–ê–ù–û

### 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω beacon_dsp_service.py (3 –º–µ—Å—Ç–∞)

**–ú–µ—Å—Ç–æ 1: –°—Ç—Ä–æ–∫–∏ 621-635** (__init__, AUTO backend):
```python
# –í–ê–ñ–ù–û: –¥–ª—è file backend –ù–ï –ø–µ—Ä–µ–¥–∞—ë–º if_offset_hz (–¥–≤–æ–π–Ω–æ–π shift)
backend_kwargs = {
    "sample_rate": SAMPLE_RATE_SPS,
    "center_freq": float(CENTER_FREQ_HZ),
    "gain_db": float(TUNER_GAIN_DB) if USE_MANUAL_GAIN else None,
    "agc": bool(ENABLE_AGC),
    "corr_ppm": int(FREQ_CORR_PPM),
    "device_args": args,
    "on_fail": "file_wait"
}
if name != "file":
    backend_kwargs["if_offset_hz"] = IF_OFFSET_HZ
self.backend = safe_make_backend(name, **backend_kwargs)
```

**–ú–µ—Å—Ç–æ 2: –°—Ç—Ä–æ–∫–∏ 662-668** (fallback –Ω–∞ file):
```python
# –í–ê–ñ–ù–û: –¥–ª—è file backend –ù–ï –ø–µ—Ä–µ–¥–∞—ë–º if_offset_hz
self.backend = safe_make_backend(
    "file",
    sample_rate=SAMPLE_RATE_SPS,
    center_freq=CENTER_FREQ_HZ,
    on_fail="file_wait"
)  # if_offset_hz —É–±—Ä–∞–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é
```

**–ú–µ—Å—Ç–æ 3: –°—Ç—Ä–æ–∫–∏ 1619-1631** (–∫–æ–º–∞–Ω–¥–∞ set_sdr_config):
```python
# –í–ê–ñ–ù–û: –¥–ª—è file backend –ù–ï –ø–µ—Ä–µ–¥–∞—ë–º if_offset_hz
backend_kwargs = {
    "sample_rate": config.get("sample_rate_sps", SAMPLE_RATE_SPS),
    "center_freq": config.get("center_freq_hz", CENTER_FREQ_HZ),
    "gain_db": config.get("gain_db", TUNER_GAIN_DB),
    "agc": ENABLE_AGC,
    "corr_ppm": FREQ_CORR_PPM,
    "device_args": new_backend_args,
    "on_fail": "file_wait"
}
if actual_backend != "file":
    backend_kwargs["if_offset_hz"] = IF_OFFSET_HZ
self.backend = safe_make_backend(actual_backend, **backend_kwargs)
```

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ test_phase_slope_dsp.py

‚úÖ **–¢–µ—Å—Ç –£–°–ü–ï–®–ù–û –ø—Ä–æ–π–¥–µ–Ω:**
```
–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ psk406msg_f150.cf32...
‚úì –ü–æ–ª—É—á–µ–Ω–æ pulse —Å–æ–±—ã—Ç–∏–µ: length=520.9 ms

–ê–Ω–∞–ª–∏–∑ —Ñ–∞–∑—ã:
  –¢–æ—á–µ–∫ –¥–∞–Ω–Ω—ã—Ö: 129734
  –î–∏–∞–ø–∞–∑–æ–Ω –≤—Ä–µ–º–µ–Ω–∏: 0.00 - 518.93 –º—Å
  –î–∏–∞–ø–∞–∑–æ–Ω —Ñ–∞–∑—ã: -1.103 - 1.103 —Ä–∞–¥  ‚Üê –ü–†–ê–í–ò–õ–¨–ù–û! (–±—ã–ª–æ ¬±1548 —Ä–∞–¥)

  –õ–∏–Ω–µ–π–Ω—ã–π –Ω–∞–∫–ª–æ–Ω:
    –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç: 0.000000 —Ä–∞–¥/–º—Å  ‚Üê –ü–†–ê–í–ò–õ–¨–ù–û!
    –ß–∞—Å—Ç–æ—Ç–Ω—ã–π —Å–¥–≤–∏–≥: 0.0 –ì—Ü
    –°–º–µ—â–µ–Ω–∏–µ: 0.000 —Ä–∞–¥

‚úì –ù–∞–∫–ª–æ–Ω –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –Ω–æ—Ä–º—ã (<0.0010 —Ä–∞–¥/–º—Å)
```

–¢–µ—Å—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç: DSP —Å–µ—Ä–≤–∏—Å —á–µ—Ä–µ–∑ ZeroMQ PUB/SUB —Å–æ–±—ã—Ç–∏—è –≤—ã–¥–∞—ë—Ç –ü–†–ê–í–ò–õ–¨–ù–£–Æ —Ñ–∞–∑—É.

### 3. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω test_phase_slope_fmplot.py (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º)

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏—Å–ø—Ä–∞–≤–∏–ª —Å—Ç—Ä–æ–∫—É 38:
```python
backend = safe_make_backend(
    "file",
    sample_rate=SAMPLE_RATE_SPS,
    center_freq=CENTER_FREQ_HZ,
    device_args=file_path,
    #if_offset_hz=IF_OFFSET_HZ  # ‚Üê –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ
)
```

–†–µ–∑—É–ª—å—Ç–∞—Ç: –¥–∏–∞–ø–∞–∑–æ–Ω —Ñ–∞–∑—ã –∏–∑–º–µ–Ω–∏–ª—Å—è —Å ¬±1548 —Ä–∞–¥ –Ω–∞ ¬±1.1 —Ä–∞–¥ ‚úÖ

### 4. –°–æ–∑–¥–∞–Ω—ã —Ç–µ—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã

- `test_phase_slope_fmplot.py` - —Ç–µ—Å—Ç –¥–ª—è beacon406_PSK_FM-plot.py (—Ä–∞–±–æ—Ç–∞–µ—Ç ‚úÖ)
- `test_phase_slope_dsp.py` - —Ç–µ—Å—Ç –¥–ª—è DSP —Å–µ—Ä–≤–∏—Å–∞ —á–µ—Ä–µ–∑ PUB/SUB (—Ä–∞–±–æ—Ç–∞–µ—Ç ‚úÖ)
- `test_dsp2plot_phase.py` - —Ç–µ—Å—Ç –¥–ª—è beacon_dsp2plot —á–µ—Ä–µ–∑ get_last_pulse (–Ω–µ –∑–∞–≤–µ—Ä—à—ë–Ω)

## ‚ùå –ß—Ç–æ –ù–ï –ü–û–õ–£–ß–ò–õ–û–°–¨

### beacon_dsp2plot.py - –ø—Ä–æ–±–ª–µ–º–∞ –û–°–¢–ê–õ–ê–°–¨

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–æ–±—â–∞–µ—Ç: **"–Ω–∞–∫–ª–æ–Ω —Ñ–∞–∑—ã –æ—Å—Ç–∞–ª—Å—è –ø—Ä–æ–±–ª–µ–º–∞ —Å beacon_dsp2plot.py –æ—Å—Ç–∞–ª–∞—Å—å"**

**–°—Ç–∞—Ç—É—Å:**
- DSP —Å–µ—Ä–≤–∏—Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –∏ –≤—ã–¥–∞—ë—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ PUB/SUB (test_phase_slope_dsp.py ‚úÖ)
- beacon_dsp2plot.py –ø–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ—Ç —Ç–æ–≥–æ –∂–µ DSP —Å–µ—Ä–≤–∏—Å–∞, –Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞–∫–ª–æ–Ω
- –ü—Ä–æ–±–ª–µ–º–∞ –ù–ï –≤ DSP —Å–µ—Ä–≤–∏—Å–µ, –∞ –≤ beacon_dsp2plot.py –∏–ª–∏ –µ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏ —Å —Å–µ—Ä–≤–∏—Å–æ–º

**–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã (—Ç—Ä–µ–±—É—é—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏):**

1. **beacon_dsp2plot.py —á–∏—Ç–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ –¥—Ä—É–≥–æ–≥–æ API**
   - test_phase_slope_dsp.py –∏—Å–ø–æ–ª—å–∑—É–µ—Ç PUB socket (—Å–æ–±—ã—Ç–∏—è "pulse")
   - beacon_dsp2plot.py –∏—Å–ø–æ–ª—å–∑—É–µ—Ç REP socket (–∫–æ–º–∞–Ω–¥–∞ get_last_pulse)
   - –í–æ–∑–º–æ–∂–Ω–æ, get_last_pulse –ø—Ä–∏–º–µ–Ω—è–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É —Ñ–∞–∑—ã

2. **–ü—Ä–æ–±–ª–µ–º–∞ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –¥–∞–Ω–Ω—ã—Ö –≤ beacon_dsp2plot.py**
   - –í–æ–∑–º–æ–∂–Ω–æ, beacon_dsp2plot.py –ø—Ä–∏–º–µ–Ω—è–µ—Ç unwrap –∏–ª–∏ –¥—Ä—É–≥—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É
   - –ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, –∫–∞–∫ beacon_dsp2plot –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ phase.x –∏ phase.y

3. **–°—Ç–∞—Ä—ã–π DSP —Å–µ—Ä–≤–∏—Å –≤—Å—ë –µ—â—ë –∑–∞–ø—É—â–µ–Ω**
   - –ù–µ—Å–∫–æ–ª—å–∫–æ background –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ beacon_dsp_service.py –º–æ–≥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
   - beacon_dsp2plot –º–æ–∂–µ—Ç –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å—Ç–∞—Ä–æ–º—É (–Ω–µ–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–º—É) —Å–µ—Ä–≤–∏—Å—É

4. **–ö–µ—à –¥–∞–Ω–Ω—ã—Ö –≤ DSP —Å–µ—Ä–≤–∏—Å–µ**
   - last_iq_seg –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –¥–∞–Ω–Ω—ã–µ, –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –¥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
   - –ù—É–∂–Ω–∞ –ø–æ–ª–Ω–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ DSP —Å–µ—Ä–≤–∏—Å–∞

## üîç –ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π –Ω–∞ –∑–∞–≤—Ç—Ä–∞

### –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –∫–∞–∫–æ–π DSP —Å–µ—Ä–≤–∏—Å –∑–∞–ø—É—â–µ–Ω
```bash
taskkill /F /IM python.exe  # –£–±–∏—Ç—å –≤—Å–µ Python –ø—Ä–æ—Ü–µ—Å—Å—ã
python beacon_dsp_service.py --pub tcp://127.0.0.1:8781 --rep tcp://127.0.0.1:8782
```

### –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å get_last_pulse API
–í—ã–ø–æ–ª–Ω–∏—Ç—å test_dsp2plot_phase.py –∏ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ get_last_pulse –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Ñ–∞–∑—É:
```bash
python test_dsp2plot_phase.py
```

–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: –¥–∏–∞–ø–∞–∑–æ–Ω —Ñ–∞–∑—ã -1.1 - 1.1 —Ä–∞–¥

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å beacon_dsp2plot.py –æ–±—Ä–∞–±–æ—Ç–∫—É
–ù–∞–π—Ç–∏ –≤ beacon_dsp2plot.py, –≥–¥–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –¥–∞–Ω–Ω—ã–µ phase.x –∏ phase.y:
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç—Ä–æ–∫–∏ 580-610 (–ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ get_last_pulse)
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –ª–∏ unwrap, remove_slope –∏–ª–∏ –¥—Ä—É–≥–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
- –í–æ–∑–º–æ–∂–Ω–æ, –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å wrapping —Ñ–∞–∑—ã: `np.mod(phase + œÄ, 2œÄ) - œÄ`

### –®–∞–≥ 4: –°—Ä–∞–≤–Ω–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç—ã –¥–∞–Ω–Ω—ã—Ö
- PUB socket (test_phase_slope_dsp.py): `phase_xs_ms`, `phase_ys_rad`
- REP get_last_pulse: `phase.x`, `phase.y`
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –ª–∏ –¥–∞–Ω–Ω—ã–µ –≤ –æ–±–æ–∏—Ö API

### –®–∞–≥ 5: –î–æ–±–∞–≤–∏—Ç—å debug –≤—ã–≤–æ–¥
–í beacon_dsp2plot.py –¥–æ–±–∞–≤–∏—Ç—å –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è phase.y:
```python
print(f"DEBUG: Phase range: {min(phase_ys)} - {max(phase_ys)} rad")
```

## üìÅ –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

‚úÖ **beacon406/beacon_dsp_service.py** - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω (3 –º–µ—Å—Ç–∞)
‚úÖ **beacon406/test_phase_slope_fmplot.py** - —Å–æ–∑–¥–∞–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
‚úÖ **beacon406/test_phase_slope_dsp.py** - —Å–æ–∑–¥–∞–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
‚ö†Ô∏è **beacon406/test_dsp2plot_phase.py** - —Å–æ–∑–¥–∞–Ω, –Ω–æ –Ω–µ –∑–∞–≤–µ—Ä—à—ë–Ω (—Ç–∞–π–º–∞—É—Ç)
‚ùå **beacon406/beacon_dsp2plot.py** - –ø—Ä–æ–±–ª–µ–º–∞ –ù–ï —Ä–µ—à–µ–Ω–∞

## üéØ –ì–ª–∞–≤–Ω—ã–π –≤—ã–≤–æ–¥

DSP —Å–µ—Ä–≤–∏—Å (beacon_dsp_service.py) **–ò–°–ü–†–ê–í–õ–ï–ù** –∏ –≤—ã–¥–∞—ë—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Ñ–∞–∑—ã (¬±1.1 —Ä–∞–¥).

–ü—Ä–æ–±–ª–µ–º–∞ –æ—Å—Ç–∞–ª–∞—Å—å –≤ **beacon_dsp2plot.py** - –ª–∏–±–æ –æ–Ω –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ —Å—Ç–∞—Ä–æ–º—É —Å–µ—Ä–≤–∏—Å—É,
–ª–∏–±–æ –ø—Ä–∏–º–µ–Ω—è–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É —Ñ–∞–∑—ã, –ª–∏–±–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –¥—Ä—É–≥–æ–π API get_last_pulse,
–∫–æ—Ç–æ—Ä—ã–π –≤–µ–¥—ë—Ç —Å–µ–±—è –∏–Ω–∞—á–µ, —á–µ–º PUB/SUB —Å–æ–±—ã—Ç–∏—è.

–ó–∞–≤—Ç—Ä–∞ –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å beacon_dsp2plot.py –∏ –µ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å DSP —Å–µ—Ä–≤–∏—Å–æ–º.
