# Patch Plan — 2025-09-26 — beacon_tester_web: RINGBUFFER + API + UI polling

## Кратко
Добавляем: кольцевой буфер IQ, сбор сегмента по абсолютным индексам, API `/api/init|run|stop|state|last_pulse`, опрос фронтендом, таблицу/графики с реальными числами. Всё аддитивно (STRICT_COMPAT).

## Файлы
- `beacon_tester_web.py` — точечные вставки, помеченные `# STRICT_COMPAT`.
- Встроенный фронтенд — минимум JS: `setInterval(pollState, 1000)` + обновление таблицы/канваса.

## План (7 шагов)
1. Глобалы: `iq_ring`, длина, индексация, `_ensure_iq_ring()`.
2. Утилиты: `get_actual_fs()`, `get_iq_segment_by_abs(start_abs, end_abs)`.
3. Запись в кольцо в `process_samples_realtime(...)` **после** NCO-смещения.
4. Время и длительности считать через `fs = get_actual_fs()`.
5. В `detect_pulses(...)` вместо сырого `iq_data` — `iq_seg` из кольца.
6. API-маршруты управления и состояния.
7. JS: `pollState()` раз в 1 с, отрисовка таблицы «Current», обновление графика.

## Критерии «Готово»
- `/api/state` отдаёт: `running`, `sdr`, `fs_sps`, `rms_dbm`, `last_pulse`.
- При реальном импульсе в UI: **длина** (мс), **время** (локально), **RMS** обновляется каждую секунду.
- Графики/таблицы меняются без перезапуска сервера.
- RTL показывает ~1.024 MS/s, RSA — ~0.875 MS/s (пример).
- При множественных импульсах не теряем сегменты (берём из кольца).

## Команды проверки
```bash
# Файловый режим
python beacon_tester_web.py
# Открыть http://127.0.0.1:8738/
# Нажать: Measure → Run

# API руками
curl -X POST http://127.0.0.1:8738/api/init
curl -X POST http://127.0.0.1:8738/api/run
curl        http://127.0.0.1:8738/api/state
curl        http://127.0.0.1:8738/api/last_pulse
curl -X POST http://127.0.0.1:8738/api/stop
```

## Ожидаемые поля
- `fs_sps`: фактическая частота дискретизации (с/с).
- `rms_dbm`: плавающее, обновляется ~каждую секунду.
- `last_pulse.length_ms`: 300–500 мс (пример для PSK406).
- `last_pulse.timestamp`: unix-epoch (в UI → локальное время).

## Типичные ловушки
- Пишем в кольцо **после** NCO, чтобы сегмент был в БП.
- Проверяем выход за окно кольца — редкие долгие задержки.
- Защищаем общие метрики `data_lock`.
- Порог `PULSE_THRESH_DBM` может требовать подстройки для разных SDR.
