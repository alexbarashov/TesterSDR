# Отчет по исправлению проблемы с Preamble в RUN режиме

## Проблема
В веб-интерфейсе COSPAS/SARSAT Beacon Tester v2.1 кнопка RUN показывала `Preamble = 0`, в то время как кнопка FILE корректно показывала `Preamble ≈ 156 мс` для того же CF32 файла.

## Анализ проблемы
- **edges[0]** в обоих режимах был одинаковый: **39124**
- **Источник данных** одинаковый: файл `psk406msg_f75.cf32`
- **Расчет preamble** отсутствовал в RUN режиме

## Что было сделано

### 1. Исследование кода
- Проанализирован файл `beacon406/beacon_tester_web.py`
- Найдена функция `analyze_psk406()` (строки 165-280) - обработка RUN режима
- Найдена обработка FILE режима (около строки 850)

### 2. Обнаружена причина
В функции `analyze_psk406()` (RUN режим) **отсутствовал расчет preamble_ms**, который присутствовал в FILE режиме:

```python
# FILE режим (работал корректно)
FSd = sample_rate / 4.0  # 250000.0
if edges_list and len(edges_list) > 0:
    preamble_ms = float(edges_list[0] / FSd * 1e3)

# RUN режим (отсутствовал расчет)
# preamble_ms не вычислялся вообще!
```

### 3. Исправление
Добавлен недостающий код в функцию `analyze_psk406()`:

```python
# Добавляем расчет preamble_ms из edges[0] как в FILE режиме
FSd = fs / 4.0  # Частота дискретизации после децимации
if edges is not None and len(edges) > 0:
    preamble_ms = float(edges[0] / FSd * 1e3)
    result['preamble_ms'] = preamble_ms
    # Записываем для отладки
    with open("../preamble_run_debug.txt", "w") as f:
        f.write(f"[RUN] preamble_ms = {preamble_ms:.3f} (edges[0]={edges[0]}, FSd={FSd})\n")
    print(f"[RUN] Calculated preamble_ms = {preamble_ms:.3f}")
```

### 4. Тестирование
Проведено тестирование обоих режимов:

**FILE режим:**
```
[FILE] preamble_ms = 156.496 (edges[0]=39124, FSd=250000.0)
```

**RUN режим (после исправления):**
```
[RUN] preamble_ms = 156.496 (edges[0]=39124, FSd=250000.0)
```

## Результат ✅

- ✅ **edges[0]**: 39124 (одинаково в обоих режимах)
- ✅ **preamble_ms**: 156.496 мс (теперь одинаково в обоих режимах)
- ✅ **FSd**: 250000.0 Гц (частота дискретизации после децимации)

## ПРОБЛЕМА НЕ ПОЛНОСТЬЮ РЕШЕНА ❌

### Что НЕ работает
**Preamble в веб-интерфейсе RUN режима все еще показывает 0**, несмотря на то, что:
1. Расчет preamble_ms добавлен в код
2. Значение корректно записывается в `result['preamble_ms']`
3. Отладочные файлы показывают правильное значение 156.496 мс

### Возможные причины
1. **Фронтенд не получает данные**: JavaScript не обновляет поле Preamble
2. **API не передает preamble_ms**: В ответе `/api/status` отсутствует поле
3. **Синхронизация данных**: RUN режим работает асинхронно, данные могут не передаваться в интерфейс
4. **Кэширование**: Старые данные могут кэшироваться в браузере

### Следующие шаги для полного решения
1. Проверить `/api/status` endpoint - передается ли `preamble_ms`
2. Проверить JavaScript код обновления интерфейса
3. Убедиться что `result` с `preamble_ms` корректно сохраняется в глобальной переменной STATE
4. Проверить обновление веб-страницы в реальном времени

## Файлы изменены
- `beacon406/beacon_tester_web.py` - добавлен расчет preamble_ms в analyze_psk406()

## Файлы отладки созданы
- `preamble_run_debug.txt` - отладка RUN режима
- `preamble_file_debug.txt` - отладка FILE режима
- `edges_run_debug.txt` - edges в RUN режиме
- `edges_file_debug.txt` - edges в FILE режиме

## Формула расчета Preamble
```python
preamble_ms = edges[0] / FSd * 1000
где:
- edges[0] = индекс первого фронта фазы (39124)
- FSd = fs / 4.0 = частота дискретизации после децимации (250000 Гц)
- 1000 = перевод в миллисекунды
```

Результат: 39124 / 250000 * 1000 = 156.496 мс

## Дата исправления
26 сентября 2025 г.