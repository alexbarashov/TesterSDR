# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

Этот файл предоставляет руководство для Claude Code (claude.ai/code) при работе с кодом в этом репозитории.

# Языковые инструкции
Всегда отвечай на русском языке. Если генерируешь коммиты/описания/тексты — делай это по-русски, если явно не попросили иначе.

## Обзор репозитория

TesterSDR — это приложение для программно-определяемого радио (SDR) для анализа и демодуляции сигналов аварийных радиобуев 406 МГц (EPIRB/COSPAS-SARSAT). Система поддерживает множество SDR-устройств и может обрабатывать как данные в реальном времени, так и записанные IQ-данные.

## Команды быстрого запуска

### Основные команды разработки

```bash
# Запуск веб-интерфейса (рекомендуется для большинства задач)
python beacon406/beacon_tester_web.py  # Открывается на http://127.0.0.1:8738/

# Или используйте Windows batch-файл
app.bat  # Запускает веб-интерфейс и автоматически открывает браузер

# Остановка Flask серверов и освобождение портов
stop_flask.bat  # Завершает все Python процессы и освобождает порты 8737-8740

# Запуск основного приложения визуализации
cd beacon406
python beacon406-plot.py

# Запуск GUI-приложения
python beacon_tester_gui.py

# Запуск GUI передатчика PSK406
python beacon406/apps/gen/ui_psk406_tx.py
```

### Проверка стиля и типизации

Команды для линтинга и проверки типов не настроены. Стиль кода следует стандартным соглашениям Python.

### Тестирование обработки сигналов

```bash
# Тестирование с включенными CF32 файлами
python beacon406/apps/test_cf32_RMS.py
python beacon406/apps/test_cf32_to_phase_msg_FFT.py

# Генерация тестовых сигналов
python beacon406/apps/gen/generate_psk406_cf32.py

# Циклическая передача сигнала через HackRF (каждые 4 секунды)
beacon406/apps/gen/406_msg_send_4sec.bat

# Декодирование EPIRB сообщений из hex
python beacon406/apps/epirb_hex_decoder.py
```

## Архитектура

### Основные компоненты

**beacon406/** - Основной Python модуль, содержащий:
- `beacon406-plot.py` - Основное приложение визуализации с обработкой сигналов в реальном времени, RMS-анализом и PSK-демодуляцией
- `beacon_tester_gui.py` - PySide6/Qt GUI приложение со спектром, водопадом, PSK-демодуляцией
- `beacon_tester_web.py` - Веб-интерфейс на Flask для тестера маяков COSPAS (порт 8738) с загрузкой и обработкой CF32 файлов
- `lib/backends.py` - Унифицированный слой абстракции SDR, поддерживающий RTL-SDR, HackRF, Airspy, SDRPlay, RSA306 и воспроизведение файлов
- `lib/demod.py` - Алгоритмы PSK-демодуляции с безопасным извлечением сообщений
- `lib/metrics.py` - Фазовые метрики и обработка PSK импульсов
- `lib/config.py` - Выбор и настройка бэкенда (по умолчанию режим воспроизведения файлов)
- `lib/hex_decoder.py` - Декодер сообщений EPIRB/COSPAS-SARSAT для 144-битных сообщений маяков

**beacon406/apps/** - Приложения и утилиты:
- `epirb_hex_decoder.py` - Автономная утилита декодирования EPIRB HEX сообщений
- Тестовые скрипты: `test_cf32_*.py` - Различные утилиты обработки и тестирования CF32 файлов
- `test_f32_to_beacon.py` - Тестирование обработки сигналов маяков
- **gen/** подкаталог - Инструменты генерации и передачи сигналов:
  - `generate_psk406_cf32.py` - Генерация тестовых PSK406 сигналов
  - `psk406_msg_gen.py` - Генератор PSK406 сообщений
  - `backend_hackrf_tx.py` - Бэкенд передачи HackRF
  - `ui_psk406_tx.py` - GUI интерфейс передачи
  - `ui_prefs.json` - Настройки интерфейса передатчика
  - `406_msg_send_4sec.bat` - Циклическая передача через HackRF

**captures/** - Каталог для хранения CF32 IQ записей
**captures/uploads/** - Каталог для файлов, загруженных через веб-интерфейс

### Система бэкендов

Приложение использует унифицированную систему бэкендов (`lib/backends.py`), которая абстрагирует различные SDR-устройства. Ключевые бэкенды:
- `SoapyBackend` - Универсальный интерфейс для устройств, поддерживаемых SoapySDR
- `FilePlaybackBackend` - Воспроизведение CF32 записей с опциональной компенсацией IF смещения
- Специфичные реализации для RTL-SDR, HackRF, Airspy, SDRPlay, RSA306

Выбор бэкенда контролируется через `lib/config.py`:
- `BACKEND_NAME`: "auto", "soapy_rtl", "soapy_hackrf", "soapy_airspy", "soapy_sdrplay", "rsa306", "file"
- `BACKEND_ARGS`: Параметры, специфичные для устройства, или путь к файлу для воспроизведения
- Режим `"auto"` автоматически обнаруживает доступное SDR-оборудование в последовательности: RTL-SDR → HackRF → Airspy → SDRPlay → RSA306
- Каждое SDR имеет калибровочные смещения и оптимальные частоты дискретизации, определенные в `SDR_CALIB_OFFSETS_DB` и `SDR_DEFAULT_HW_SR`

### Архитектура потоков данных

Система следует четкому конвейеру данных:

1. **Этап ввода**: SDR-устройство или CF32 файлы → Комплексные IQ отсчеты
2. **Этап детекции**: Расчет RMS → Детекция импульсов → Извлечение сегментов
3. **Этап обработки**: Извлечение фазы → Фильтрация → Децимация → Удаление тренда
4. **Этап демодуляции**: Детекция фронтов → Манчестерское декодирование → Извлечение байтов
5. **Этап вывода**: HEX сообщение → Декодирование COSPAS-SARSAT → Презентация в UI

### Модель потоков

- **beacon406-plot.py**: Однопоточный с циклом событий matplotlib
- **beacon_tester_gui.py**: QThread для захвата SDR, главный поток для UI
- **beacon_tester_web.py**: Flask в многопоточном режиме, отдельная обработка для каждого запроса

## Конфигурация

Отредактируйте `beacon406/lib/config.py` для выбора SDR бэкенда:
```python
# Для воспроизведения файлов:
BACKEND_NAME = "file"
BACKEND_ARGS = r"C:/work/TesterSDR/captures/your_recording.cf32"

# Для RTL-SDR:
BACKEND_NAME = "soapy_rtl"
BACKEND_ARGS = None

# Для HackRF:
BACKEND_NAME = "soapy_hackrf"
BACKEND_ARGS = None

# Для автоопределения:
BACKEND_NAME = "auto"
BACKEND_ARGS = None
```

## Зависимости

Установите необходимые пакеты:
```bash
pip install numpy matplotlib pyqtgraph PyQt5 PySide6 scipy flask werkzeug
# Для поддержки SDR-устройств:
pip install SoapySDR
# Для поддержки RSA306 (если используется оборудование Tektronix):
pip install pyVISA
# Для прямой поддержки RTL-SDR:
pip install pyrtlsdr
```

## Конвейер обработки сигналов

### Процесс PSK-демодуляции
1. **Детекция фронтов** (`demod.py`)
   - `detect_all_steps_by_mean_fast()` - Находит фазовые переходы используя скользящее окно (40 отсчетов, порог 0.5)
   - Начинает с отсчета 25000, чтобы пропустить начальные переходные процессы
   - Использует кумулятивную сумму для сложности O(1) на шаг

2. **Извлечение данных** (`demod.py`)
   - `extract_half_bits()` - Выборка фазы в серединах между фронтами
   - `halfbits_to_bytes_fast()` - Конвертирует манчестерски кодированные биты (10→1, 01→0)
   - Обрабатывает до 500 полубитов (250 бит, 31.25 байт)

3. **Обработка фазы** (`metrics.py`)
   - ФНЧ на 12 кГц с 129-отводным FIR фильтром (окно Хэмминга)
   - 4x децимация после фильтрации
   - Удаление линейного тренда для компенсации частотного сдвига
   - Нулевая фазовая референция из первых 2мс базовой линии

4. **Анализ импульсов** (`demod.py:calculate_pulse_params()`)
   - PosPhase/NegPhase: Среднее высоких/низких плато
   - PhRise/PhFall: Времена переходов 10%-90% с субдискретной интерполяцией
   - Ass: Метрика асимметрии из временных различий τ1/τ2
   - Tmod: Медианный период между нарастающими фронтами

5. **Декодирование сообщений** (`hex_decoder.py`)
   - Декодирует 144-битные сообщения маяков COSPAS-SARSAT
   - Извлекает протокол, код страны, ID маяка, позицию и другие поля
   - Поддерживает как location, так и user протоколы

### Обработка в веб-интерфейсе (beacon_tester_web.py)

1. **Загрузка CF32 файлов**
   - Загрузка .cf32 файлов через веб-интерфейс
   - Файлы сохраняются в каталог `captures/uploads/`
   - Автоматическая обработка при загрузке

2. **Детекция сигнала**
   - `_find_pulse_segment()` - Детекция импульсов на основе RMS
   - Порог: -60 dBm по умолчанию
   - Окно: 1.0 мс для расчета RMS
   - Фильтрует импульсы короче 5 мс

3. **Извлечение фазы**
   - `process_cf32_file()` - Полный конвейер обработки сигнала
   - Вызывает `process_psk_impulse()` для данных фазы
   - Вызывает `phase_demod_psk_msg_safe()` для извлечения сообщения
   - Возвращает данные фазы, временную ось и декодированное HEX сообщение

4. **Режимы веб-интерфейса**
   - "Current" - Отображение метрик в реальном времени
   - "Message" - Показать таблицу декодированных EPIRB сообщений
   - "121 MHz Data" - Отображение параметров маяков 121.5 МГц
   - Визуализация графика фазы с временной осью

### Ключевые параметры в `beacon406-plot.py`
- `TARGET_SIGNAL_HZ`: Целевая частота сигнала (406.037 МГц для маяков)
- `IF_OFFSET_HZ`: Промежуточная частота смещения для настройки (-37 кГц типично)
- `SAMPLE_RATE_SPS`: Частота дискретизации (обычно 1 МГц)
- `RMS_WIN_MS`: Размер окна RMS в миллисекундах (1.0 мс)
- `VIS_DECIM`: Фактор децимации визуализации (2048)
- `PULSE_THRESH_DBM`: Порог детекции (-45 dBm)
- `READ_CHUNK`: Размер буфера чтения SDR (65536 отсчетов)

### Ключевые параметры в `beacon_tester_web.py`
- `SAMPLE_RATE`: 1 МГц для обработки CF32
- `RMS_THRESH_DBM`: -60.0 dBm порог детекции импульсов
- `RMS_WIN_MS`: 1.0 мс окно RMS
- `START_DELAY_MS`: 3.0 мс начальный пропуск
- `CALIB_DB`: -30.0 dB калибровочное смещение
- `PSK_BASELINE_MS`: 10.0 мс для фазовой референции

## Архитектура веб-интерфейса

Веб-интерфейс (`beacon_tester_web.py`) воспроизводит оригинальный COSPAS Beacon Tester v2:

### Компоненты JavaScript фронтенда
- **Управление видами**: Обрабатывает режимы Current/Message/121MHz
- **Рисование графиков**: Фазовый график на canvas с прореживанием
- **Загрузка файлов**: Асинхронная обработка CF32 файлов
- **Опрос данных**: Периодические обновления статуса через `/api/status`

### Flask маршруты бэкенда
- `GET /`: Главная страница интерфейса
- `POST /api/upload`: Конечная точка обработки CF32 файлов
- `GET /api/status`: Текущие метрики и данные фазы
- `POST /api/{measure,run,cont,break}`: Управляющие команды

### Управление состоянием
- Глобальный dataclass `STATE` хранит текущие измерения
- Потокобезопасные обновления через контекст запросов Flask
- Постоянные данные фазы между запросами

## Форматы файлов

- **CF32 файлы**: Комплексные float32 IQ отсчеты (чередующиеся I/Q пары)
- Частота дискретизации и центральная частота должны соответствовать параметрам записи
- Файловый бэкенд применяет компенсацию IF смещения при воспроизведении

## Тестирование

Формальный фреймворк тестирования не настроен. Тестируйте функциональность используя:
- Скрипты в каталоге `apps/` для специфичных тестов обработки сигналов
- Режим воспроизведения файлов с записанными сигналами в `captures/`
- Тестирование в реальном времени с подключенным SDR-оборудованием
- Веб-интерфейс с загрузкой CF32 файлов для быстрого тестирования

### Доступные тестовые файлы
Каталог `captures/` содержит множество тестовых записей для разработки и тестирования:
- **Тестовые сигналы PSK406**: `psk406msg_f*.cf32` (сгенерированные на разных частотах: 50, 75, 100, 150 Гц)
- **Реальные SDR захваты**: `iq_pulse_406-*.cf32`, `iq_pulse_20250916_*.cf32` (актуальные записи маяков)
- **AIS сигналы**: `iq_pulse_AIS_*.cf32` (морские AIS тестовые сигналы)
- **DSC сигналы**: `iq_pulse_DSC_*.cf32` (тестовые данные цифрового селективного вызова)
- **AM121 данные**: `iq_121*.cf32` (записи аварийной частоты 121.5 МГц)
- **RSA306 захваты**: Различные записи Tektronix RSA306

## Оптимизации производительности

### Алгоритмическая сложность
- **Детекция фронтов**: O(1) на отсчет используя кумулятивную сумму
- **Обработка фазы**: Векторизованные операции NumPy
- **График веб-интерфейса**: Прореживание до ~1000 точек для плавной отрисовки
- **Конвертация данных**: Пакетная конвертация строковых массивов в числа

### Управление памятью
- CF32 файлы загружаются частями для больших файлов
- Кольцевые буферы для данных SDR в реальном времени
- Децимация уменьшает объем данных в 4 раза после фильтрации

## Важные детали реализации

### Управление процессами Windows
- `stop_flask.bat` - завершает все Python процессы и освобождает порты 8737-8740
- Автоматическое управление портами Flask серверов
- Поддержка множественных Flask экземпляров на разных портах

### Обработка путей
- Пути в стиле Windows с прямыми слешами (например, `C:/work/TesterSDR/`)
- Абсолютные пути требуются для файловых операций
- Batch файлы используют жестко заданные пути Python (текущий путь в app.bat: `C:\Users\alexb\AppData\Local\Programs\Python\Python39\python.exe` - обновите при необходимости)

### Версия Python
- Минимум: Python 3.9 (по умолчанию в batch файле)
- Протестировано до: Python 3.13
- Подсказки типов не обязательны, но используются в новом коде

### Обработка ошибок
- `phase_demod_psk_msg_safe()` никогда не вызывает исключений
- SDR бэкенды корректно обрабатывают underflow
- Веб-интерфейс валидирует загрузки перед обработкой

### Сетевые порты
- Веб-интерфейс: Порт 8738 (COSPAS Beacon Tester)
- Все интерфейсы привязаны к 127.0.0.1 (только localhost)

### Специфика SDR
- Децимация частоты дискретизации для устройств > 1 МС/с
- Компенсация IF смещения в режиме воспроизведения файлов
- Калибровочные смещения для каждого типа SDR
- Поддержка автоматической регулировки усиления (AGC) варьируется по устройствам

### UI фреймворки
- GUI: PySide6 (Qt6) предпочтительно, PyQt5 как запасной вариант
- Веб: Flask с vanilla JavaScript (без фреймворков)
- График: Matplotlib с интерактивными функциями

### Система генерации сигналов
- Полный модуль генерации и передачи в `beacon406/apps/gen/`
- GUI интерфейс передачи с настройками в JSON
- Поддержка циклической передачи через HackRF
- Интеграция с PothosSDR через `hackrf_transfer.exe`

### Среда разработки
- VS Code настройки в `.vscode/settings.json`
- PYTHONPATH конфигурация в `.env`
- Git репозиторий инициализирован (без remote)